<script>
  const BACKEND_URL = 'ephemeral-chat-backend-production-1085.up.railway.app';
  const output = document.getElementById('output');
  const input = document.getElementById('input');
  const promptEl = document.getElementById('prompt');
  let socket;
  let username = 'guest';
  let currentCode = '';
  let typingTimer;

  function addLine(text, type = 'normal') {
    const line = document.createElement('div');
    line.className = `line ${type}`;
    line.innerHTML = text;
    output.appendChild(line);
    output.scrollTop = output.scrollHeight;
  }

  function setPrompt(name) {
    promptEl.innerHTML = `┌─[${name}@${currentCode || 'chat'} ~]<br>└─$`;
  }

  function sendCommand(cmd) {
    if (!cmd.trim()) return;
    addLine(`┌─[${username}@${currentCode || 'chat'} ~]<br>└─$ ${cmd}`);

    if (cmd === 'clear') {
      output.innerHTML = '';
      return;
    }
    if (cmd === 'help') {
      addLine(`<span class="help">
  help     show commands<br>
  clear    clear screen<br>
  who      show users online<br>
  exit     leave chat<br>
  [msg]    send message
      </span>`);
      return;
    }
    if (cmd === 'exit') {
      if (socket) socket.disconnect();
      addLine('<span class="system" style="color:#ff5555">Disconnected. Chat closed.</span>');
      setTimeout(() => location.reload(), 1500);
      return;
    }
    if (cmd === 'who') {
      if (socket) socket.emit('request users');
      return;
    }

    if (socket && currentCode) {
      socket.emit('chat message', cmd);
    }
  }

  // === JOIN LOGIC (FIXED) ===
  const urlParams = new URLSearchParams(window.location.search);
  const urlCode = urlParams.get('code');

  if (urlCode) {
    currentCode = urlCode;
    // Show login screen
    addLine(`<span class="system">SSH Login to ephemeral-chat</span>`);
    addLine(`<span class="system">Chat Code: <strong>${currentCode}</strong></span>`);
    addLine(`<span class="system">Enter username:</span>`);
    input.placeholder = "Type your name and press Enter";
    input.focus();

    // Wait for user to type name and press Enter
    const handleName = (e) => {
      if (e.key === 'Enter') {
        const name = input.value.trim();
        if (!name) {
          addLine('<span class="system" style="color:#ff5555">Username required!</span>');
          return;
        }
        username = name;
        input.value = '';
        input.placeholder = "Type a message...";
        input.removeEventListener('keydown', handleName);
        setPrompt(username);
        connectToChat(currentCode);
      }
    };
    input.addEventListener('keydown', handleName);

  } else {
    // No code → ask for one
    addLine(`<span class="system">Welcome to Ephemeral SSH Chat</span>`);
    addLine(`<span class="system">Enter chat code to connect:</span>`);
    input.placeholder = "e.g., secret123";
    input.focus();

    const handleCode = (e) => {
      if (e.key === 'Enter') {
        const code = input.value.trim();
        if (!code) return;
        currentCode = code;
        input.value = '';
        input.placeholder = "Enter your username...";
        input.removeEventListener('keydown', handleCode);

        addLine(`<span class="system">Chat Code: <strong>${code}</strong></span>`);
        addLine(`<span class="system">Enter username:</span>`);

        const handleName = (e) => {
          if (e.key === 'Enter') {
            const name = input.value.trim() || 'guest';
            username = name;
            input.value = '';
            input.placeholder = "Type a message...";
            input.removeEventListener('keydown', handleName);
            history.pushState(null, '', `?code=${code}`);
            setPrompt(username);
            connectToChat(code);
          }
        };
        input.addEventListener('keydown', handleName);
      }
    };
    input.addEventListener('keydown', handleCode);
  }

  function connectToChat(code) {
    socket = io(BACKEND_URL, { transports: ['websocket'] });

    socket.on('connect', () => {
      socket.emit('join', { code, username });
      addLine(`<span class="system" style="color:#00ff00">Connected as <strong>${username}</strong>. Type 'help'.</span>`);
    });

    socket.on('connect_error', (err) => {
      addLine(`<span class="system" style="color:#ff5555">Connection failed: ${err.message}</span>`);
    });

    socket.on('chat message', (data) => {
      if (data.username === username) return;
      addLine(`┌─[${data.username}@${currentCode} ~]<br>└─$ ${data.msg}`);
    });

    socket.on('system message', (msg) => {
      addLine(`<span class="system">* ${msg}</span>`);
    });

    socket.on('user typing', (name) => {
      clearTimeout(typingTimer);
      let typingEl = document.querySelector('.typing');
      if (!typingEl) {
        typingEl = document.createElement('div');
        typingEl.className = 'typing';
        output.appendChild(typingEl);
      }
      typingEl.textContent = `${name} is typing...`;
      output.scrollTop = output.scrollHeight;

      typingTimer = setTimeout(() => {
        if (typingEl) typingEl.remove();
      }, 1500);
    });

    socket.on('chat closed', () => {
      addLine('<span class="system" style="color:#ff5555">Chat terminated. All data erased.</span>');
      setTimeout(() => location.reload(), 2000);
    });
  }

  // === INPUT HANDLING ===
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = input.value.trim();
      input.value = '';
      if (currentCode && socket) {
        sendCommand(cmd);
        socket.emit('typing', false);
      }
    } else if (e.key.length === 1 && currentCode && socket) {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        socket.emit('typing', true);
      }, 300);
    }
  });

  // Keep focus
  document.addEventListener('click', () => input.focus());
</script>